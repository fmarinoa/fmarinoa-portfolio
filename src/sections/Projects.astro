---
import { Image } from 'astro:assets'
import GithubIcon from '@/assets/icons/github.svg'
import Link from '@/components/Link.astro'
import Section from '@/components/Section.astro'
import RightArrow from '@/assets/icons/arrow-right.svg'
import { getProjects } from '@/lib/content'
import type { Project } from '@/types'

const styleLink = 'bg-gray-700 px-2 py-1 rounded inline-flex items-center gap-1'
const projects = await getProjects()

// [last, all, first]
const carouselProjects = [
  projects[projects.length - 1],
  ...projects,
  projects[0],
]
---

<Section sectionId="projects" title="Proyectos personales">
  <div class="relative w-full h-[520px] overflow-hidden">
    <div
      class="hidden md:block absolute top-0 left-0 w-12 md:w-16 h-full bg-gradient-to-r from-gray-900 via-gray-900/40 to-transparent z-5 pointer-events-none"
    >
    </div>
    <div
      class="hidden md:block absolute top-0 right-20 md:right-24 w-20 md:w-24 h-full bg-gradient-to-l from-gray-900 via-gray-900/40 to-transparent z-5 pointer-events-none"
    >
    </div>

    <button
      id="next-btn"
      class="absolute top-0 right-0 z-10 bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 text-white h-full w-12 md:w-24 transition flex items-center justify-center text-2xl hover:from-gray-900 hover:via-gray-700 hover:to-gray-900 border-gray-700 rounded-l-xl md:rounded-l-none md:rounded-r-xl"
      aria-label="Siguiente"
    >
      <RightArrow />
    </button>

    <div class="h-full max-w-full overflow-hidden mr-10 md:ml-5">
      <div
        id="projects-carousel"
        class="flex gap-6 h-full transition-transform duration-700 ease-in-out pr-20"
      >
        {
          carouselProjects.map((project: Project) => (
            <article
              class="project-card group flex flex-col w-[300px] md:w-[450px] h-full shrink-0 bg-gradient-to-br from-gray-800 to-gray-900 
            rounded-xl shadow-xl border border-gray-700 hover:border-indigo-400 hover:shadow-2xl 
            p-6 transition-all duration-300 whitespace-normal"
            >
              {project.urls.image && (
                <div class="aspect-video w-full mb-4 rounded-lg overflow-hidden">
                  <Image
                    src={project.urls.image}
                    alt={project.title}
                    width={300}
                    height={169}
                    class="w-full h-full object-cover select-none"
                    loading="lazy"
                  />
                </div>
              )}

              <h3 class="text-xl font-bold text-white mb-2 tracking-tight group-hover:text-indigo-400 transition-colors">
                {project.title}
              </h3>
              <p class="text-sm text-white mb-4">{project.description}</p>

              <div class="flex flex-wrap gap-2 mb-4">
                {project.technologies.map(tech => (
                  <span class="bt-tech px-2 py-1 rounded text-xs font-medium">
                    {tech}
                  </span>
                ))}
              </div>

              <div class="flex justify-end w-full text-sm mt-auto">
                {project.urls.demo && (
                  <Link
                    href={project.urls.demo}
                    className={`${styleLink} mr-2`}
                  >
                     Demo
                  </Link>
                )}
                {project.urls.github && (
                  <Link href={project.urls.github} className={styleLink}>
                    <Image
                      src={GithubIcon}
                      alt="GitHub"
                      width={48}
                      height={48}
                      format="webp"
                      class="size-5"
                    />
                    C贸digo
                  </Link>
                )}
              </div>
            </article>
          ))
        }
      </div>
    </div>
  </div>
</Section>

<style>
  .bt-tech {
    color: hsl(var(--primary));
    background-color: hsl(var(--primary) / 0.1);
  }

  article {
    border-color: rgb(55, 65, 81);
  }

  article:hover {
    border-color: rgb(129, 140, 248);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  article:hover h3 {
    color: rgb(129, 140, 248);
  }

  /* Deja que se asome el siguiente card */
  #projects-carousel {
    will-change: transform;
    cursor: grab;
  }

  #projects-carousel:active {
    cursor: grabbing;
  }
</style>

<script>
  const carousel = document.getElementById('projects-carousel')
  const cards = carousel?.querySelectorAll('.project-card')
  const nextBtn = document.getElementById('next-btn')

  if (!carousel || !cards || !nextBtn) {
    throw new Error('Carousel elements not found')
  }

  let currentIndex = 1 // Empezar en la primera carta real (despu茅s de la duplicada)
  let autoSlide: ReturnType<typeof setTimeout> | null = null
  let isTransitioning = false

  // Variables para drag and drop
  let isDragging = false
  let startX = 0
  let startTranslate = 0
  let currentTranslate = 0

  const totalCards = cards.length
  const autoSlideInterval = 15 * 1000 // 15 seconds
  let remainingTime = autoSlideInterval
  let lastTime = Date.now()

  const getCardWidth = () => {
    const firstCard = cards[0] as HTMLElement
    return firstCard?.offsetWidth ? firstCard.offsetWidth + 24 : 0
  }

  const updateCarousel = (animate = true) => {
    const cardWidth = getCardWidth()
    carousel.style.transition = animate ? 'transform 0.7s ease-in-out' : 'none'
    carousel.style.transform = `translateX(-${currentIndex * cardWidth}px)`
  }

  // Funciones para drag and drop
  const handleDragStart = (e: MouseEvent | TouchEvent) => {
    if (isTransitioning) return
    isDragging = true
    startX = 'touches' in e ? e.touches[0].clientX : e.clientX
    startTranslate = -currentIndex * getCardWidth()
    carousel.style.transition = 'none'
    pauseAutoSlide()
  }

  const handleDragMove = (e: MouseEvent | TouchEvent) => {
    if (!isDragging) return
    e.preventDefault()
    const x = 'touches' in e ? e.touches[0].clientX : e.clientX
    const deltaX = x - startX
    currentTranslate = startTranslate + deltaX
    carousel.style.transform = `translateX(${currentTranslate}px)`
  }

  const handleDragEnd = () => {
    if (!isDragging) return
    isDragging = false

    const dragDistance = currentTranslate - startTranslate
    const threshold = getCardWidth() * 0.2 // 20% del ancho de la card

    if (Math.abs(dragDistance) > threshold) {
      if (dragDistance > 0) {
        // Arrastrando hacia la derecha - ir atr谩s (slide anterior)
        prevSlide()
      } else {
        // Arrastrando hacia la izquierda - ir adelante (slide siguiente)
        nextSlide()
      }
    } else {
      // Si no pas贸 el threshold, volver a la posici贸n original
      updateCarousel()
    }

    // Reiniciar el auto-slide despu茅s de cualquier interacci贸n de drag
    restartAutoSlide()
  }

  const nextSlide = () => {
    if (isTransitioning) return

    isTransitioning = true
    currentIndex++
    updateCarousel()

    // Si llegamos al final, configurar listener para reset autom谩tico
    if (currentIndex >= totalCards - 1) {
      const handleTransitionEnd = () => {
        carousel.removeEventListener('transitionend', handleTransitionEnd)
        currentIndex = 1
        updateCarousel(false)
        isTransitioning = false
      }
      carousel.addEventListener('transitionend', handleTransitionEnd)
    } else {
      setTimeout(() => {
        isTransitioning = false
      }, 100)
    }
  }

  const prevSlide = () => {
    if (isTransitioning) return

    isTransitioning = true
    currentIndex--
    updateCarousel()

    // Si llegamos al inicio, configurar listener para reset autom谩tico
    if (currentIndex <= 0) {
      const handleTransitionEnd = () => {
        carousel.removeEventListener('transitionend', handleTransitionEnd)
        currentIndex = totalCards - 2
        updateCarousel(false)
        isTransitioning = false
      }
      carousel.addEventListener('transitionend', handleTransitionEnd)
    } else {
      setTimeout(() => {
        isTransitioning = false
      }, 100)
    }
  }

  const startAutoSlide = () => {
    // Limpiar cualquier timeout existente
    if (autoSlide) {
      clearTimeout(autoSlide)
      autoSlide = null
    }

    lastTime = Date.now()
    autoSlide = setTimeout(() => {
      nextSlide()
      remainingTime = autoSlideInterval
      startAutoSlide()
    }, remainingTime)
  }

  const stopAutoSlide = () => {
    if (autoSlide) {
      clearTimeout(autoSlide)
      autoSlide = null
    }
  }

  const pauseAutoSlide = () => {
    if (autoSlide) {
      clearTimeout(autoSlide)
      autoSlide = null
      remainingTime = Math.max(1000, remainingTime - (Date.now() - lastTime))
    }
  }

  const resumeAutoSlide = () => {
    // Solo reanudar si no hay un timeout activo
    if (!autoSlide) {
      if (remainingTime <= 0) remainingTime = autoSlideInterval
      startAutoSlide()
    }
  }

  const restartAutoSlide = () => {
    stopAutoSlide()
    remainingTime = autoSlideInterval
    startAutoSlide()
  }

  nextBtn.addEventListener('click', () => {
    nextSlide()
    restartAutoSlide()
  })

  // Event listeners para drag and drop
  carousel.addEventListener('mousedown', handleDragStart)
  carousel.addEventListener('mousemove', handleDragMove)
  carousel.addEventListener('mouseup', handleDragEnd)
  carousel.addEventListener('mouseleave', handleDragEnd)

  // Touch events para m贸viles
  carousel.addEventListener('touchstart', handleDragStart)
  carousel.addEventListener('touchmove', handleDragMove)
  carousel.addEventListener('touchend', handleDragEnd)

  carousel.addEventListener('mouseenter', pauseAutoSlide)
  carousel.addEventListener('mouseleave', resumeAutoSlide)
  window.addEventListener('resize', () => updateCarousel(false))

  // Posicionar el carrusel en la primera carta real al inicio
  updateCarousel(false)
  startAutoSlide()
</script>
