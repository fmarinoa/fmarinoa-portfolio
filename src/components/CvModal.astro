---
import Alert from './Alert.astro'
---

<div
  id="cv-modal"
  class="fixed inset-0 items-center justify-center bg-black/50 z-50 hidden"
>
  <div
    class="bg-gradient-to-br from-gray-800 to-gray-900 border border-indigo-400 transition-all duration-300 p-5 rounded-lg shadow-md max-w-xs text-center"
  >
    <h2 id="modal-title" class="sr-only">Confirmación de descarga</h2>
    <p id="modal-description" class="text-white font-medium mb-3">
      Será redirigido a la descarga de mi CV
    </p>
    <div class="flex justify-center gap-2">
      <button
        id="confirm-btn"
        class="px-4 py-2 rounded transition-colors bg-indigo-500 text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed hover:cursor-pointer"
      >
        De acuerdo
      </button>
      <button
        id="cancel-btn"
        class="px-4 py-2 rounded transition-colors bg-gray-300 text-gray-800 hover:bg-gray-400 hover:cursor-pointer"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>

<Alert />

<script>
  import { actions } from 'astro:actions'

  const cvModal = document.getElementById('cv-modal') as HTMLElement
  const confirmBtn = document.getElementById('confirm-btn') as HTMLButtonElement

  let isLoading = false
  let alertTimeout: NodeJS.Timeout | null = null

  function showAlert(message: string, state: 'success' | 'failed' = 'success') {
    const alertElement = document.getElementById('alert')
    if (!alertElement) return

    if (alertTimeout) {
      clearTimeout(alertTimeout)
      alertTimeout = null
    }

    alertElement.classList.remove('success', 'failed', 'hidden')
    alertElement.textContent = message
    alertElement.classList.add(state)

    alertTimeout = setTimeout(() => {
      alertElement.classList.add('hidden')
      alertTimeout = null
    }, 5000)
  }

  function openModal() {
    cvModal?.classList.remove('hidden')
    cvModal?.classList.add('flex')
  }

  function closeModal() {
    cvModal?.classList.add('hidden')
    cvModal?.classList.remove('flex')
  }

  async function handleConfirm() {
    if (isLoading) return

    try {
      isLoading = true
      confirmBtn.disabled = true
      confirmBtn.textContent = 'Cargando...'

      const { data, error } = await actions.getCvUrl()

      if (error || !data?.cvUrl) {
        showAlert('No se pudo obtener la URL del CV', 'failed')
        return
      }

      window.open(data.cvUrl, '_blank', 'noopener,noreferrer')
      showAlert('¡Gracias por abrir mi CV!', 'success')
    } catch (error) {
      showAlert('Error al cargar el CV. Intenta de nuevo', 'failed')
    } finally {
      closeModal()
      isLoading = false
      confirmBtn.disabled = false
      confirmBtn.textContent = 'De acuerdo'
    }
  }

  document.addEventListener('click', e => {
    const target = e.target as HTMLElement
    if (!target) return

    if (target.closest(`#cv-btn`)) openModal()
    else if (target.closest('#cancel-btn')) closeModal()
    else if (target === cvModal) closeModal()
    else if (target === confirmBtn) handleConfirm()
  })
</script>
